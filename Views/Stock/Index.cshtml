@using Microsoft.AspNetCore.Mvc.Rendering
@model IEnumerable<Sistema_Gestion_Inventario.Models.StockActualRow>
@{
    ViewData["Title"] = "Stock actual";
    Layout = "_Layout";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-dark fw-bold">
            <i class="bi bi-boxes me-2"></i> Stock actual (SP)
        </h2>

        <form id="formExport" asp-controller="Stock" asp-action="ExportarExcel" method="post" class="d-flex gap-2">
            @Html.AntiForgeryToken()
            <input type="hidden" name="idProducto" id="exportIdProducto" />
            <input type="hidden" name="idAlmacen" id="exportIdAlmacen" />
            <button id="btnExportar" type="submit" class="btn btn-success">
                <i class="bi bi-file-earmark-excel-fill me-1"></i> Exportar a Excel
            </button>
        </form>
    </div>

    <form method="get" asp-action="Index" class="card shadow mb-4">
        <div class="card-body bg-light">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Producto</label>
                    <select id="IdProducto" name="idProducto" class="form-select select2" asp-items="@(ViewData["IdProducto"] as SelectList)">
                        <option value="">(Todos)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Almacén</label>
                    <select id="IdAlmacen" name="idAlmacen" class="form-select select2" asp-items="@(ViewData["IdAlmacen"] as SelectList)">
                        <option value="">(Todos)</option>
                    </select>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-1"></i> Filtrar
                </button>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table id="stockTable" class="table table-striped table-hover align-middle rounded shadow">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>SKU</th>
                    <th>Almacén (código)</th>
                    <th>Almacén</th>
                    <th>Stock actual</th>
                    <th>Último movimiento</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model)
                {
                    <tr>
                        <td>@r.Producto</td>
                        <td>@r.Sku</td>
                        <td>@r.AlmacenCodigo</td>
                        <td>@r.Almacen</td>
                        <td>@r.StockActual.ToString("N2")</td>
                        <td>@(r.UltimoMovimiento?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}
@section Scripts {
    <!-- DataTables ya está cargado en _Layout (v2.x). Solo Select2 aquí. -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(function () {
            $('.select2').select2({ width: '100%', placeholder: 'Seleccione...', allowClear: true });

            $('#stockTable').DataTable({
                language: { url: "https://cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json" },
                ordering: true,
                paging: true,
                searching: true
            });

            const sync = () => {
                $('#exportIdProducto').val($('#IdProducto').val());
                $('#exportIdAlmacen').val($('#IdAlmacen').val());
            };
            sync();
            $('#IdProducto,#IdAlmacen').on('change', sync);

            $('#formExport').on('submit', function () {
                Swal.fire({
                    title: 'Generando Excel…',
                    text: 'Preparando la descarga.',
                    icon: 'info',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => Swal.showLoading()
                });
                setTimeout(() => { Swal.close(); }, 2500);
            });
        });
    </script>
}